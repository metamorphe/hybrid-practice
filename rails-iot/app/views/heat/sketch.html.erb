   <script type="text/javascript">
      var files = <%= @files.to_json.html_safe %>;
      var DEFAULT_PIPE_FILE = "example_sunmoon_4inches.svg";
      var ah, ps;
      
      $(function(){ 
        $("#shade").fadeOut("slow");
        paperSetup('myCanvas');
        ps = new PerceptualScheduler(paper);
        hs = new HeatSketch();

        var brush_direction = null;
        brush = new paper.Tool();
        brush.onMouseDown = function(event){
          
          brush_direction = new paper.Path.Line({
            strokeColor: "yellow", 
            strokeWidth: 3, 
            from: event.point,
            to: event.point,
          });
          var c = new paper.Path.Circle({
            fillColor: "red", 
            position: event.point, 
            radius: 5
          });
        }
        brush.onMouseDrag = function(event){
          brush_direction.lastSegment.remove();
          brush_direction.addSegment(event.point);
        }
        brush.onMouseUp = function(event){
          var c = new paper.Path.Circle({
            fillColor: "blue", 
            position: event.point, 
            radius: 5
          });
          brush_direction.addSegment(event.point);

          var boundary = CanvasUtil.queryPrefix('BND')[0];
          
          console.log(brush_direction.getTangentAt(brush_direction.length/2.0));
          
          var start = brush_direction.getPointAt(0);
          var direction = brush_direction.getTangentAt(brush_direction.length/2.0);
          HeatSketch.snake(start, direction, boundary, CanvasUtil.queryPrefix('BAR'));

          brush_direction = null;
         
        }
      });
      
      function paperSetup(id){
        var dom = $("#" + id);
        dom.attr('height', dom.parent().height());
        dom.attr('width', dom.parent().width());
        paper.install(window);
        var myPaper = new paper.PaperScope();
        myPaper.setup(id);
        console.log("Paper.js installed on", id);
        return myPaper;
      }
      
    </script>
  </head>
  <body>
      <div id="view-container">
			<div id="main-canvas-container">
			  <canvas id="myCanvas" class="paper"></canvas>
			</div>
      </div>
  </body>

  <style>
   	body, html{
   		width: 100%;
   		height: 100%;
   		background: #f5f4f0;
      	/*overflow: hidden;*/
   	}
    #view-container{
      height: 100%;
      /*overflow: hidden;*/
    }
    #main-canvas{
		height: 100%;
	}
	#main-canvas-container{
	  position: relative;
	  height: calc(100% - 0px);
	  width: 100%;
	  overflow: hidden;
	}
	.paper{
	  background: #f5f4f0;
	  position: relative;
	  top: 0px;
	  z-index: 0;
	  cursor: pointer;
	  -webkit-box-shadow: inset 2px 4px 15px 2px rgba(0,0,0,0.2);
		-moz-box-shadow: inset 2px 4px 15px 2px rgba(0,0,0,0.2);
		box-shadow: inset 2px 4px 15px 2px rgba(0,0,0,0.2);
	}
  </style>
