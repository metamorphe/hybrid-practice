<!DOCTYPE html>
<html>
	<head>
		<title>Grey Gradient Picker</title>
		<script type="text/javascript" src="libs/jquery.min.js"></script>
		<script type="text/javascript" src="libs/paper-full.min.js"></script>
		<script type="text/javascript" src="libs/bootstrap.min.js"></script>
		<script type="text/javascript" src="libs/underscore.js"></script>
		<script type="text/javascript" src="libs/saveas.min.js"></script>
		<script type="text/javascript" src="js/artwork.js"></script>
		<script type="text/javascript" src="js/ruler.js"></script>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.css"></style>

		<script type="text/javascript">
		 	var eld;
			var gradientRectArray = [];
			$(function(){
				// MAIN FUNCTION
				$('#downloadButton').click(function(){
					_.each(gradientRectArray, function(rect) {
						rect.remove();
					});

					console.log("clicked");
					$(this).attr('href', $('#myCanvas')[0].toDataURL("image/png") ).attr('download', 'mymodel.png');
				});
				$('#downloadButtonSVG').click(function(){
					_.each(gradientRectArray, function(rect) {
						rect.remove();
					});

					console.log("clicked");
					console.log("Exporting file as SVG");
					zoom = 1;
					paper.view.update();
		
					exp = paper.project.exportSVG({ 
						asString: true,
						precision: 5
					});
					saveAs(new Blob([exp], {type:"application/svg+xml"}), "mymodel.svg")
				});
				$('#myCanvas').attr('height', $(window).height());
				$('#myCanvas').attr('width', $(window).width());
	

				paper.install(window);
				paper.setup('myCanvas');

				eld = new Artwork("img/necklace.svg", function(display) {
					runScript(display);
				});
			});
				
			function runScript(display){

				var selectedFillColor;
				var diffusers = eld.queryPrefix("DIF");
				var decorations = eld.queryPrefix("DD");
				var NLED = eld.queryPrefix("NLED");
				let MAX_GREY_COLOR = 0.2;
				let LEVEL_ONE_COLOR = new paper.Color(MAX_GREY_COLOR - 0.2);
				let LEVEL_TWO_COLOR = new paper.Color(MAX_GREY_COLOR - 0.1);
				let LEVEL_THREE_COLOR = new paper.Color(MAX_GREY_COLOR - 0.05);
				
				var hitOptions = {
					segments: true,
					stroke: true,
					fill: true,
					tolerance: 1
				};

				t = new paper.Tool();

				// function generateColorRectangles() {

					// var levelOne = new Path.Rectangle({
					// 	position: new Point(200, 25),
					// 	fillColor: new paper.Color(0.2),
 				// 		strokeColor: "black",
 				// 		isGradientRect: true,
					// 	size: 25
					// })

				// 	var levelTwo = new Path.Rectangle({
				// 		position: new Point(200, 50),
				// 		fillColor: new paper.Color(0.1),
				// 		strokeColor: "black",
				// 		isGradientRect: true,
				// 		size: 25
				// 	})

				// 	var levelThree = new Path.Rectangle({
				// 		position: new Point(200, 75),
				// 		fillColor: new paper.Color(0.05),
				// 		strokeColor: "black",
				// 		isGradientRect: true,
				// 		size: 25
				// 	})

				// 	var blankRect = new Path.Rectangle({
				// 		position: new Point(200, 100),
				// 		fillColor: "white",
				// 		strokeColor: "black",
				// 		isClearRect: true,
				// 		size: 25
				// 	})

				// 	gradientRectArray.push(levelOne, levelTwo, levelThree, blankRect);
				// };

				t.onMouseDown = function(event) {
					var hitResult = project.hitTest(event.point, hitOptions);

					if (!hitResult) {
						console.log("No Hit");
						return;
					};

					console.log(hitResult.item.type);

					if (hitResult.item.isGradientRect) {
						selectedFillColor = hitResult.item.fillColor;
					} else if (hitResult.item.isClearRect) {
						selectedFillColor = null;
					}

					if (selectedFillColor) {
						hitResult.item.fillColor = selectedFillColor;
					};
				};

				function generateColors() {

					var circularDecorations = _.filter(decorations, function(decoration) {
						return decoration.type == "circle";
					});

					var ellipticDecorations = _.filter(decorations, function(decoration) {
						return decoration.type == "ellipse";
					})
					_.each(NLED, function(nled) {
						nled.fillColor = LEVEL_THREE_COLOR;
					})

					_.each(diffusers, function(diffuser) {
						diffuser.fillColor = LEVEL_TWO_COLOR;
					})

					_.each(decorations, function(decoration) {
						decoration.fillColor = LEVEL_ONE_COLOR;
					})

					_.each(circularDecorations, function(decoration) {
						decoration.fillColor = new paper.Color(MAX_GREY_COLOR - 0.13);
					});

					_.each(ellipticDecorations, function(decoration) {
						decoration.fillColor = new paper.Color(MAX_GREY_COLOR - 0.21);
					})


				};

				function init() {
					// generateColorRectangles();
					var cp = eld.queryPrefix("CP");
					cp[0].remove();
					var bo = eld.queryPrefix("BO");
					bo[0].remove();
					var bi = eld.queryPrefix("BI");
					bi[0].remove();
					var nled = eld.queryPrefix("NLED");
					_.each(nled, function(led) {
						led.remove();
					})

					generateColors();


					var boundBox = new Path.Rectangle({
						position: new Point(630, 350),
 						strokeColor: "black",
 						strokeWidth: 5,
 						isGradientRect: true,
						size: 430
					});
					boundBox.bounds.height= 410;
					boundBox.bounds.width = 450;

					console.log(Ruler.pts2mm(boundBox.bounds.width));
					console.log(Ruler.pts2mm(boundBox.bounds.height));

				};

				init();

			};
			
		</script>
	</head>
	<body>
		<div class="container">
			<canvas id="myCanvas"></canvas>
			<a id="downloadButton" class='btn btn-default'>DOWNLOAD</a>
			<a id="downloadButtonSVG" class='btn btn-default'> DOWNLOAD SVG </a>
		</div>
	</body>
</html>

<style> 
	#downloadButtonSVG{
		position: absolute;
		top: 80px;
		left: 20px;
	}
	#downloadButton{
		position: absolute;
		top: 20px;
		left: 20px;
	}
	#myCanvas{
		position: absolute;
		left: 0;
		top: 0;
	}
	body, html{
		margin: 0;
		padding: 0;
		background: white;
	}
</style>
